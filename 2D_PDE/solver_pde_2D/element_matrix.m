% ---------------------------------------------------------- %
% [Ae] = element_matrix(xy,x,lx,ly)
%
% compute stiffness matrix for each element
%
% input: xy
%        x
%        lx
%        ly
%
% output: Ae
% ---------------------------------------------------------- %
function [Ae] = element_matrix(xy,x,lx,ly)
%% pre-setting
% step size in each direction
hlx = 2^-lx; hly = 2^-ly;
% number of elements
nel = 2^lx * 2^ly; 
% initialise local element matrix
Ae = zeros(nel,4,4);

% % linear PDE with constant coefficient 1
% Ae(:,1,1) = 1/3*(hly/hlx + hlx/hly); Ae(:,2,2) = Ae(:,1,1); Ae(:,3,3) = Ae(:,1,1); Ae(:,4,4) = Ae(:,1,1);
% Ae(:,1,2) = (-1/3*(hly/hlx) + 1/6*(hlx/hly)); Ae(:,2,1)=Ae(:,1,2); Ae(:,3,4)=Ae(:,1,2); Ae(:,4,3)=Ae(:,1,2);
% Ae(:,1,3) = -1/6*(hly/hlx + hlx/hly); Ae(:,3,1)=Ae(:,1,3); Ae(:,2,4)=Ae(:,1,3); Ae(:,4,2)=Ae(:,1,3);
% Ae(:,1,4) = (-1/3*(hlx/hly) + 1/6*(hly/hlx)); Ae(:,4,1)=Ae(:,1,4); Ae(:,2,3)=Ae(:,1,4); Ae(:,3,2)=Ae(:,1,4);

% local element matrix
xyleft = xy(xy(:,1)<1,:); xyleft = xyleft(xyleft(:,2)<1,:);
u1 = x(1); u2 = x(2);
x2 = xyleft(:,1)+hlx; x1 = xyleft(:,1);
y2 = xyleft(:,2)+hly; y1 = xyleft(:,2);

coe1 = u1/hlx^2/hly^2;
coe2 = u2/hlx^2/hly^2;

sin3x1 = sin(3*x1);  sin3y1 = sin(3*y1); 
sin3x2 = sin(3*x2);  sin3y2 = sin(3*y2);
sinx1  = sin(x1);    siny1  = sin(y1);
sinx2  = sin(x2);    siny2  = sin(y2);

cos3x1 = cos(3*x1);  cos3y1 = cos(3*y1);
cos3x2 = cos(3*x2);  cos3y2 = cos(3*y2);
cosx1  = cos(x1);    cosy1  = cos(y1);
cosx2  = cos(x2);    cosy2  = cos(y2);

%% compute each entry of the matrix
Ae(:,1,1) = (hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(1/3*cos3y1*hly^2 + 2/9*sin3y1*hly)-...
    1/3*(cos3y2-cos3y1).*(-1/3*sin3x1*hlx^2 + 2/9*cos3x1*hlx)+...
    4/81*(cos3y2-cos3y1).*(sin3x2-sin3x1) ) + ...
        coe2*( (sinx2-sinx1).*(cosy1*hly^2 + 2*siny1*hly)-...
    (cosy2-cosy1).*(-sinx1*hlx^2 + 2*cosx1*hlx)+...
    4*(cosy2-cosy1).*(sinx2-sinx1) );

Ae(:,2,2) = (hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(1/3*cos3y1*hly^2 + 2/9*sin3y1*hly)-...
    1/3*(cos3y2-cos3y1).*(1/3*sin3x2*hlx^2 + 2/9*cos3x2*hlx)+...
    4/81*(cos3y2-cos3y1).*(sin3x2-sin3x1) ) + ...
        coe2*( (sinx2-sinx1).*(cosy1*hly^2 + 2*siny1*hly)-...
    (cosy2-cosy1).*(sinx2*hlx^2 + 2*cosx2*hlx)+...
    4*(cosy2-cosy1).*(sinx2-sinx1) );

Ae(:,3,3) = (hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(-1/3*cos3y2*hly^2 + 2/9*sin3y2*hly)-...
    1/3*(cos3y2-cos3y1).*(1/3*sin3x2*hlx^2 + 2/9*cos3x2*hlx)+...
    4/81*(cos3y2-cos3y1).*(sin3x2-sin3x1) ) + ...
        coe2*( (sinx2-sinx1).*(-cosy2*hly^2 + 2*siny2*hly)-...
    (cosy2-cosy1).*(sinx2*hlx^2 + 2*cosx2*hlx)+...
    4*(cosy2-cosy1).*(sinx2-sinx1) );

Ae(:,4,4) = (hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(-1/3*cos3y2*hly^2 + 2/9*sin3y2*hly)-...
    1/3*(cos3y2-cos3y1).*(-1/3*sin3x1*hlx^2 + 2/9*cos3x1*hlx)+...
    4/81*(cos3y2-cos3y1).*(sin3x2-sin3x1) ) + ...
        coe2*( (sinx2-sinx1).*(-cosy2*hly^2 + 2*siny2*hly)-...
    (cosy2-cosy1).*(-sinx1*hlx^2 + 2*cosx1*hlx)+...
    4*(cosy2-cosy1).*(sinx2-sinx1) );

Ae(:,1,2) = (-hly/hlx + 0.5*hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(-1/3*cos3y1*hly^2 - 2/9*sin3y1*hly)...
    +1/3*(cos3y2-cos3y1)*1/9*hlx.*(cos3x2+cos3x1)...
    -4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1).*(-cosy1*hly^2 - 2*siny1*hly)...
    +(cosy2-cosy1)*hlx.*(cosx2+cosx1)...
    -4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,2,1) = Ae(:,1,2);

Ae(:,1,3) = -0.5*(hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1)*1/9*hly.*(sin3y2+sin3y1)...
    -1/3*(cos3y2-cos3y1)*1/9*hlx.*(cos3x2+cos3x1)...
    +4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1)*hly.*(siny2+siny1)...
    -(cosy2-cosy1)*hlx.*(cosx2+cosx1)...
    +4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,3,1) = Ae(:,1,3);

Ae(:,1,4) = (-hlx/hly + 0.5*hly/hlx) + ...
        coe1*( 1/3*(sin3x2-sin3x1)*(-1/9)*hly.*(sin3y2+sin3y1)...
    +1/3*(cos3y2-cos3y1).*(-1/3*sin3x1*hlx^2+2/9*cos3x1*hlx)...
    -4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1)*(-1)*hly.*(siny2+siny1)...
    +(cosy2-cosy1).*(-sinx1*hlx^2+2*cosx1*hlx)...
    -4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,4,1) = Ae(:,1,4);

Ae(:,2,3) = (-hlx/hly + 0.5*hly/hlx) + ...
        coe1*( 1/3*(sin3x2-sin3x1)*(-1/9)*hly.*(sin3y2+sin3y1)...
    +1/3*(cos3y2-cos3y1).*(1/3*sin3x2*hlx^2+2/9*cos3x2*hlx)...
    -4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1)*(-1)*hly.*(siny2+siny1)...
    +(cosy2-cosy1).*(sinx2*hlx^2+2*cosx2*hlx)...
    -4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,3,2) = Ae(:,2,3);

Ae(:,2,4) = -0.5*(hly/hlx + hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1)*(1/9)*hly.*(sin3y2+sin3y1)...
    +1/3*(cos3y2-cos3y1)*(-1/9)*hlx.*(cos3x2+cos3x1)...
    +4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1)*hly.*(siny2+siny1)...
    +(cosy2-cosy1)*(-1)*hlx.*(cosx2+cosx1)...
    +4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,4,2) = Ae(:,2,4);

Ae(:,3,4) = (-hly/hlx + 0.5*hlx/hly) + ...
        coe1*( 1/3*(sin3x2-sin3x1).*(1/3*cos3y2*hly^2-2/9*sin3y2*hly)...
    +1/3*(cos3y2-cos3y1)*(1/9)*hlx.*(cos3x2+cos3x1)...
    -4/81*(sin3x2-sin3x1).*(cos3y2-cos3y1) ) + ...
        coe2*( (sinx2-sinx1).*(cosy2*hly^2-2*siny2*hly)...
    +(cosy2-cosy1)*hlx.*(cosx2+cosx1)...
    -4*(sinx2-sinx1).*(cosy2-cosy1) );

Ae(:,4,3) = Ae(:,3,4);

end

